<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>36&nbsp; Option Volume: Introduction â€“ Python for Data Science in Finance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/34_option_volume_feature_selection/option_volume_feature_selection.html" rel="next">
<link href="../../chapters/32_student_loan_xgboost/student_loan_xgboost.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-443a9a13d6c97aa3c21a69484c274cdc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../parts/04_classical_machine_learning/classical_machine_learning.html">Classical Machine Learning</a></li><li class="breadcrumb-item"><a href="../../chapters/33_option_volume_introduction/option_volume_introduction.html"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Option Volume: Introduction</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Python for Data Science in Finance</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/01_jumpstart/jumpstart.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Python Jumpstart</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../parts/01_part_basic_data_wrangling/part_basic_data_wrangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Data Wrangling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/02_dataframe_basics/dataframe_basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title"><code>DataFrame</code> Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/03_index_slice/index_slice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title"><code>DataFrame</code> Indexing and Slicing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/04_query/query.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title"><code>DataFrame</code> Querying</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/05_functions_apply/functions_apply.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Functions and the <code>DataFrame.apply()</code> Method</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/06_merge/merge.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Merging <code>DataFrames</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/07_groupby_aggregation_part_1/groupby_aggregation_part_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title"><code>.groupby()</code> and <code>.agg()</code> - 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/08_groupby_aggregation_part_2/groupby_aggregation_part_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title"><code>.groupby()</code> and <code>.agg()</code> - 2</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../parts/02_part_visualization/part_visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualization</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/09_pandas_line_graphs/pandas_line_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Line Graphs with <strong>pandas</strong></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/10_pandas_bar_charts/pandas_bar_charts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Bar Charts with <strong>pandas</strong></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/11_pandas_scatter_plots/pandas_scatter_plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Scatter Plots with <strong>pandas</strong></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/12_seaborn/seaborn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Visualization with <strong>seaborn</strong></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/13_bokeh_basic/bokeh_basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Basic Plotting with <strong>bokeh</strong></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/14_bokeh_advanced/bokeh_advanced.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Advanced Plotting with <strong>bokeh</strong></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../parts/03_data_analysis/data_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/15a_option_replication/option_replication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Black-Scholes-Merton Option Replication</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/15b_asset_allocation/asset_allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Asset Allocation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/16_trend_following/trend_following.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Trend Following</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/17_regression_mutual_fund/regression_mutual_fund.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Regression: Mutual Fund Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/18_close_to_close/close_to_close.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Volatility Forecasting: Close-to-Close Estimator</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/19_garch/garch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Volatility Forecasting: GARCH</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/20_feed_grains_database/feed_grains_database.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Exploration of the Feed Grains Database</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../parts/04_classical_machine_learning/classical_machine_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classical Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/21_simple_linear_regression/simple_linear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Simple Linear Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/22_categorical_linear_regression/categorical_linear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Linear Regression with Categorical Variables</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/23_ridge_lasso_regression/ridge_lasso_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Ridge and Lasso Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/24_k_nearest_neighbors_cross_validation/k_nearest_neighbors_cross_validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">K Nearest Neighbors &amp; Cross-Validation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/25_stock_prediction/stock_prediction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Predicting Stock Returns</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/26a_pca/pca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Principal Components Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/26b_principal_components_regression/principal_components_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Principal Components Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/26c_principal_components_logistic_regression/principal_components_logistic_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Principal Components Logistic Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/27_k_means_clustering/k_means_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">K-Means Clustering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/28_pca_visualization/pca_visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Visualizing Principal Components Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/29_student_loan_overfitting/student_loan_overfitting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Student Loan: Overfitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/30_student_loan_alternative_metric/student_loan_alternative_metric.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Student Loan: Alternative Metric &amp; Cross-Validation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/31_student_loan_hyperparameter_tuning/student_loan_hyperparameter_tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Student Loan: Hyperparameter Tuning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/32_student_loan_xgboost/student_loan_xgboost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Student Loan: <strong>xgboost</strong></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/33_option_volume_introduction/option_volume_introduction.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Option Volume: Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/34_option_volume_feature_selection/option_volume_feature_selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Option Volume: Feature Selection and Hyperparameter Tuning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/35_option_volume_xgboost/option_volume_xgboost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Option Volume: <strong>xgboost</strong></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../parts/05_neural_networks/neural_networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural Networks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/36a_mnist_digit_recognition/mnist_digit_recognition.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">MNIST Digit Recognition</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/36b_imdb_classification/imdb_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">IMBD Movie Reviews</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/36c_reuters_classification/reuters_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Reuters: Classifying Newswires</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/36d_boston_house_price_regression/boston_house_price_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Boston Housing Prices</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/37_student_loan_neural_network/student_loan_neural_network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Student Loan: Neural Network</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/38_exchange_rate/exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Exchange Rate Prediction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/39_stock_prediction_neural_network/stock_prediction_neural_network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Stock Returns: Neural Network</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/40_numerai/numerai.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Numerai</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/41_exchange_rate_rnn/exchange_rate_rnn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Exchange Rate: Recurrent Neural Network</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../parts/06_natural_language_processing/natural_language_processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Natural Language Processing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/41a_spacy_introduction/spacy_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Introduction to <strong>spaCy</strong></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/41b_nltk_introduction/nltk_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">Introduction to <strong>nltk</strong></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/41c_vectorizing_text/vectorizing_text.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Vectorizing Text</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/41d_sentiment_analysis_stock_headlines/sentiment_analysis_stock_headlines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">Sentiment Analysis on Stock Headlines</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../parts/07_miscellaneous/miscellaneous.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Miscellaneous</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/42_virtual_environments/virtual_environments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">52</span>&nbsp; <span class="chapter-title">Virtual Enviroments</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/43_pipelines_pickles/pipelines_pickles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">53</span>&nbsp; <span class="chapter-title"><code>Pipelines</code> and <code>pickles</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/44_columntransformers/columntransformers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">54</span>&nbsp; <span class="chapter-title"><code>ColumnTransformers</code></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#importing-packages" id="toc-importing-packages" class="nav-link active" data-scroll-target="#importing-packages"><span class="header-section-number">36.1</span> Importing Packages</a></li>
  <li><a href="#reading-in-data" id="toc-reading-in-data" class="nav-link" data-scroll-target="#reading-in-data"><span class="header-section-number">36.2</span> Reading-In Data</a></li>
  <li><a href="#wrangling-selecting-the-universe" id="toc-wrangling-selecting-the-universe" class="nav-link" data-scroll-target="#wrangling-selecting-the-universe"><span class="header-section-number">36.3</span> Wrangling: Selecting the Universe</a></li>
  <li><a href="#wrangling-handling-zero-implied-vols" id="toc-wrangling-handling-zero-implied-vols" class="nav-link" data-scroll-target="#wrangling-handling-zero-implied-vols"><span class="header-section-number">36.4</span> Wrangling: Handling Zero Implied Vols</a></li>
  <li><a href="#feature-construction-of-training-set-2017-and-backtest-set-2018" id="toc-feature-construction-of-training-set-2017-and-backtest-set-2018" class="nav-link" data-scroll-target="#feature-construction-of-training-set-2017-and-backtest-set-2018"><span class="header-section-number">36.5</span> Feature Construction of Training Set (2017) and Backtest Set (2018)</a></li>
  <li><a href="#exploratory-data-analysis-of-training-data" id="toc-exploratory-data-analysis-of-training-data" class="nav-link" data-scroll-target="#exploratory-data-analysis-of-training-data"><span class="header-section-number">36.6</span> Exploratory Data Analysis of Training Data</a></li>
  <li><a href="#top-n-ratio" id="toc-top-n-ratio" class="nav-link" data-scroll-target="#top-n-ratio"><span class="header-section-number">36.7</span> Top-<span class="math inline">\(n\)</span> Ratio</a></li>
  <li><a href="#a-simple-rule-based-predictor" id="toc-a-simple-rule-based-predictor" class="nav-link" data-scroll-target="#a-simple-rule-based-predictor"><span class="header-section-number">36.8</span> A Simple Rule-Based Predictor</a></li>
  <li><a href="#user-defined-functions" id="toc-user-defined-functions" class="nav-link" data-scroll-target="#user-defined-functions"><span class="header-section-number">36.9</span> User Defined Functions</a></li>
  <li><a href="#calculating-performance-of-simple-rule-based-predictor" id="toc-calculating-performance-of-simple-rule-based-predictor" class="nav-link" data-scroll-target="#calculating-performance-of-simple-rule-based-predictor"><span class="header-section-number">36.10</span> Calculating Performance of Simple Rule-Based Predictor</a></li>
  <li><a href="#simple-linear-regression" id="toc-simple-linear-regression" class="nav-link" data-scroll-target="#simple-linear-regression"><span class="header-section-number">36.11</span> Simple Linear Regression</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../parts/04_classical_machine_learning/classical_machine_learning.html">Classical Machine Learning</a></li><li class="breadcrumb-item"><a href="../../chapters/33_option_volume_introduction/option_volume_introduction.html"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Option Volume: Introduction</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Option Volume: Introduction</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The function of an option market-maker is to provide liquidity on option exchanges. At any given time, they are willing to buy an option for a price slightly lower than <em>fair value</em>, and sell that same option for a price slightly higher than the fair value. The more trades a market-maker executes, the more money they make. They also have limited computing power, and thus it makes sense for them to direct their limited resources to underlyings which have the most volume. For this reason, it is useful for a market-maker to predict option volume rankings for underlyings.</p>
<p>The purpose of this chapter is to try to predict option volume rankings. In particular, we will:</p>
<ol type="1">
<li>choose a universe of moderately liquid underlyings, using 2016 volume data</li>
<li>fit a model for the aforementioned underlyings using data from 2017 (training period)</li>
<li>use this fitted model to make volume predictions for January 2018 (backtest period)</li>
</ol>
<p>Additionally, we will define the top-<span class="math inline">\(n\)</span> metric that we will use to evaluate various prediction models that we will explore in future chapters.</p>
<section id="importing-packages" class="level2" data-number="36.1">
<h2 data-number="36.1" class="anchored" data-anchor-id="importing-packages"><span class="header-section-number">36.1</span> Importing Packages</h2>
<p>Letâ€™s begin by importing the packages that we will need.</p>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="reading-in-data" class="level2" data-number="36.2">
<h2 data-number="36.2" class="anchored" data-anchor-id="reading-in-data"><span class="header-section-number">36.2</span> Reading-In Data</h2>
<p>Next letâ€™s read-in the data that we will need.</p>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df_stats <span class="op">=</span> pd.read_csv(<span class="st">'../data/option_stats.csv'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df_stock <span class="op">=</span> pd.read_csv(<span class="st">'../data/option_stock_quote.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data in <code>df_stats</code> consists of volume, open-interest, and implied volatility statistics for all available underlyings.</p>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">quotedate</th>
<th data-quarto-table-cell-role="th">implied_vol</th>
<th data-quarto-table-cell-role="th">totalvol</th>
<th data-quarto-table-cell-role="th">totaloi</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>A</td>
<td>2016-01-04</td>
<td>0.3289</td>
<td>1330</td>
<td>116961</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>AA</td>
<td>2016-01-04</td>
<td>0.4843</td>
<td>38615</td>
<td>1152498</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AAC</td>
<td>2016-01-04</td>
<td>0.8606</td>
<td>3</td>
<td>1386</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>AAL</td>
<td>2016-01-04</td>
<td>0.4096</td>
<td>56386</td>
<td>875178</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>AAN</td>
<td>2016-01-04</td>
<td>0.4471</td>
<td>23</td>
<td>5480</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2202060</td>
<td>ZTO</td>
<td>2018-01-31</td>
<td>0.4140</td>
<td>53</td>
<td>15086</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2202061</td>
<td>ZTS</td>
<td>2018-01-31</td>
<td>0.2419</td>
<td>1333</td>
<td>29890</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2202062</td>
<td>ZUMZ</td>
<td>2018-01-31</td>
<td>0.5936</td>
<td>21</td>
<td>4121</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2202063</td>
<td>ZX</td>
<td>2018-01-31</td>
<td>0.0000</td>
<td>0</td>
<td>21</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2202064</td>
<td>ZYNE</td>
<td>2018-01-31</td>
<td>0.7505</td>
<td>253</td>
<td>10646</td>
</tr>
</tbody>
</table>

<p>2202065 rows Ã— 5 columns</p>
</div>
</div>
</div>
<p>The data in <code>df_stock</code> consists of end-of-day prices for each of the underlyings.</p>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_stock</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">quotedate</th>
<th data-quarto-table-cell-role="th">px_close</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>A</td>
<td>2016-01-04</td>
<td>40.69000</td>
<td>3287300</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>AA</td>
<td>2016-01-04</td>
<td>9.70999</td>
<td>12639700</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AAC</td>
<td>2016-01-04</td>
<td>18.52000</td>
<td>119400</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>AAL</td>
<td>2016-01-04</td>
<td>40.91000</td>
<td>12037200</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>AAN</td>
<td>2016-01-04</td>
<td>22.68000</td>
<td>698000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2201883</td>
<td>ZTO</td>
<td>2018-01-31</td>
<td>15.81000</td>
<td>1121202</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2201884</td>
<td>ZTS</td>
<td>2018-01-31</td>
<td>76.77000</td>
<td>3690956</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2201885</td>
<td>ZUMZ</td>
<td>2018-01-31</td>
<td>20.75000</td>
<td>361661</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2201886</td>
<td>ZX</td>
<td>2018-01-31</td>
<td>1.31000</td>
<td>17279</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2201887</td>
<td>ZYNE</td>
<td>2018-01-31</td>
<td>12.09000</td>
<td>263042</td>
</tr>
</tbody>
</table>

<p>2201888 rows Ã— 4 columns</p>
</div>
</div>
</div>
</section>
<section id="wrangling-selecting-the-universe" class="level2" data-number="36.3">
<h2 data-number="36.3" class="anchored" data-anchor-id="wrangling-selecting-the-universe"><span class="header-section-number">36.3</span> Wrangling: Selecting the Universe</h2>
<p>We will use data from 2016 to choose the universe for our analysis. The universe we will ultimately arrive at is the 301-500 most liquid underlyings for which there is data for all of 2017 (training period) and January of 2018 (backtest period).</p>
<p>Letâ€™s begin by isolating the 2016 data from <code>df_stats</code>.</p>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df_stats_2016 <span class="op">=</span> df_stats.query(<span class="st">'quotedate &gt;= "2016-01-01"'</span>).query(<span class="st">'quotedate &lt;= "2016-12-31"'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we calculate the daily volume volume ranks for all the symbols in 2016.</p>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_volume_rank <span class="op">=</span> <span class="op">\</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    df_stats_2016</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'symbol'</span>])[[<span class="st">'totalvol'</span>]].mean()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'totalvol'</span>:<span class="st">'average_daily_volume'</span>})</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        .assign(average_daily_volume <span class="op">=</span> <span class="kw">lambda</span> df: np.<span class="bu">round</span>(df[<span class="st">'average_daily_volume'</span>]))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        .assign(volume_rank <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">'average_daily_volume'</span>].rank(ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>df_volume_rank</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">average_daily_volume</th>
<th data-quarto-table-cell-role="th">volume_rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>A</td>
<td>905.0</td>
<td>895.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>AA</td>
<td>39852.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AAC</td>
<td>108.0</td>
<td>2118.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>AAL</td>
<td>37165.0</td>
<td>60.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>AAN</td>
<td>402.0</td>
<td>1308.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4742</td>
<td>ZTO</td>
<td>358.0</td>
<td>1381.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4743</td>
<td>ZTS</td>
<td>1945.0</td>
<td>589.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4744</td>
<td>ZUMZ</td>
<td>206.0</td>
<td>1693.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4745</td>
<td>ZX</td>
<td>0.0</td>
<td>4703.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4746</td>
<td>ZYNE</td>
<td>91.0</td>
<td>2235.0</td>
</tr>
</tbody>
</table>

<p>4747 rows Ã— 3 columns</p>
</div>
</div>
</div>
<p>Letâ€™s initially create <code>df_raw_universe</code> that has more symbols than we will need because not all symbols have data for all days. In particular, we will first grab the 301-700th most liquid underlyings. In the next steps we will select only symbols that have data for all days.</p>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_universe_raw <span class="op">=</span> <span class="op">\</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    df_volume_rank</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">'volume_rank &gt;= 301 &amp; volume_rank &lt;= 700'</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        .sort_values([<span class="st">'volume_rank'</span>])</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        [[<span class="st">'symbol'</span>, <span class="st">'average_daily_volume'</span>, <span class="st">'volume_rank'</span>]]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>df_universe_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">average_daily_volume</th>
<th data-quarto-table-cell-role="th">volume_rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">624</td>
<td>BUD</td>
<td>5623.0</td>
<td>301.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2159</td>
<td>IILG</td>
<td>5619.0</td>
<td>302.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4032</td>
<td>TAP</td>
<td>5611.0</td>
<td>303.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">325</td>
<td>ASHR</td>
<td>5606.0</td>
<td>304.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3301</td>
<td>POM</td>
<td>5565.0</td>
<td>305.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2812</td>
<td>MTW</td>
<td>1441.0</td>
<td>696.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">957</td>
<td>CRC</td>
<td>1438.0</td>
<td>697.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3296</td>
<td>PNRA</td>
<td>1432.0</td>
<td>698.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1653</td>
<td>FNSR</td>
<td>1432.0</td>
<td>698.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4433</td>
<td>VIXY</td>
<td>1428.0</td>
<td>700.0</td>
</tr>
</tbody>
</table>

<p>400 rows Ã— 3 columns</p>
</div>
</div>
</div>
<p>Next, letâ€™s grab the data for both the training period (2017) and the backtest period (January 2018).</p>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df_stats_analysis <span class="op">=</span> df_stats.query(<span class="st">'quotedate &gt;= "2017-01-01"'</span>).query(<span class="st">'quotedate &lt;= "2018-01-31"'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And finally we are ready to select our universe.</p>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df_universe <span class="op">=</span> <span class="op">\</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    df_universe_raw                                                   <span class="co"># start with big universe</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        .merge(df_stats_analysis, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span><span class="st">'symbol'</span>)            <span class="co"># join volume and volatility stats</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        .merge(df_stock, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'symbol'</span>, <span class="st">'quotedate'</span>])      <span class="co"># join stock price data</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'symbol'</span>, <span class="st">'volume_rank'</span>])[[<span class="st">'quotedate'</span>]].count()    <span class="co"># count the number of rows of data that exist</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        .sort_values([<span class="st">'volume_rank'</span>])</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">'quotedate == 272'</span>)                                    <span class="co"># grab the symbols that have all 272 days worth of data - this is hardcoded</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        .assign(rerank <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">'volume_rank'</span>].rank())         <span class="co"># rerank this smaller universe</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    ).query(<span class="st">'rerank &lt;= 300'</span>)                                          <span class="co"># grab the 300 most liquid underlyings in restricted universe</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>df_universe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">volume_rank</th>
<th data-quarto-table-cell-role="th">quotedate</th>
<th data-quarto-table-cell-role="th">rerank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>BUD</td>
<td>301.0</td>
<td>272</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">321</td>
<td>TAP</td>
<td>303.0</td>
<td>272</td>
<td>2.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25</td>
<td>ASHR</td>
<td>304.0</td>
<td>272</td>
<td>3.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>AMJ</td>
<td>306.0</td>
<td>272</td>
<td>4.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">69</td>
<td>COF</td>
<td>307.0</td>
<td>272</td>
<td>5.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>AEP</td>
<td>647.0</td>
<td>272</td>
<td>296.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">259</td>
<td>PII</td>
<td>648.0</td>
<td>272</td>
<td>297.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">27</td>
<td>AU</td>
<td>649.0</td>
<td>272</td>
<td>298.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">320</td>
<td>SYY</td>
<td>650.0</td>
<td>272</td>
<td>299.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">266</td>
<td>PSTG</td>
<td>651.0</td>
<td>272</td>
<td>300.0</td>
</tr>
</tbody>
</table>

<p>300 rows Ã— 4 columns</p>
</div>
</div>
</div>
</section>
<section id="wrangling-handling-zero-implied-vols" class="level2" data-number="36.4">
<h2 data-number="36.4" class="anchored" data-anchor-id="wrangling-handling-zero-implied-vols"><span class="header-section-number">36.4</span> Wrangling: Handling Zero Implied Vols</h2>
<p>There are a number of rows in <code>df_stats_analysis</code> that have zero implied vols, which will affect our analysis down the road.</p>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df_stats_analysis.query(<span class="st">'implied_vol &lt;= 0'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">quotedate</th>
<th data-quarto-table-cell-role="th">implied_vol</th>
<th data-quarto-table-cell-role="th">totalvol</th>
<th data-quarto-table-cell-role="th">totaloi</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1066997</td>
<td>AAU</td>
<td>2017-01-03</td>
<td>0.0</td>
<td>103</td>
<td>3217</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1067042</td>
<td>ACUR</td>
<td>2017-01-03</td>
<td>0.0</td>
<td>0</td>
<td>647</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1067084</td>
<td>AFMD</td>
<td>2017-01-03</td>
<td>0.0</td>
<td>50</td>
<td>1655</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1067140</td>
<td>ALIM</td>
<td>2017-01-03</td>
<td>0.0</td>
<td>0</td>
<td>2454</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1067150</td>
<td>ALQA</td>
<td>2017-01-03</td>
<td>0.0</td>
<td>0</td>
<td>16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2201849</td>
<td>VVUS</td>
<td>2018-01-31</td>
<td>0.0</td>
<td>0</td>
<td>5085</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2201895</td>
<td>WG</td>
<td>2018-01-31</td>
<td>0.0</td>
<td>0</td>
<td>1598</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2201967</td>
<td>XCOOQ</td>
<td>2018-01-31</td>
<td>0.0</td>
<td>0</td>
<td>10573</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2202017</td>
<td>XSPA</td>
<td>2018-01-31</td>
<td>0.0</td>
<td>3</td>
<td>3031</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2202063</td>
<td>ZX</td>
<td>2018-01-31</td>
<td>0.0</td>
<td>0</td>
<td>21</td>
</tr>
</tbody>
</table>

<p>45968 rows Ã— 5 columns</p>
</div>
</div>
</div>
<p>Letâ€™s take care of these now. We will set these implied vols to the average non-zero implied vol in the data set. There are probably more sophisticated ways to do this that are more accurate, but using this crude approach will not affect the analysis.</p>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>non_zero_mean <span class="op">=</span> df_stats_analysis.query(<span class="st">'implied_vol &gt; 0'</span>)[<span class="st">'implied_vol'</span>].mean()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df_stats_analysis.loc[df_stats_analysis.implied_vol <span class="op">==</span> <span class="dv">0</span>, <span class="st">"implied_vol"</span>] <span class="op">=</span> non_zero_mean</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>df_stats_analysis.query(<span class="st">'implied_vol &lt;= 0'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">quotedate</th>
<th data-quarto-table-cell-role="th">implied_vol</th>
<th data-quarto-table-cell-role="th">totalvol</th>
<th data-quarto-table-cell-role="th">totaloi</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="feature-construction-of-training-set-2017-and-backtest-set-2018" class="level2" data-number="36.5">
<h2 data-number="36.5" class="anchored" data-anchor-id="feature-construction-of-training-set-2017-and-backtest-set-2018"><span class="header-section-number">36.5</span> Feature Construction of Training Set (2017) and Backtest Set (2018)</h2>
<p>Letâ€™s define the training set, and create the features that we may want to use.</p>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> <span class="op">\</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    df_universe[[<span class="st">'symbol'</span>,<span class="st">'rerank'</span>]]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'rerank'</span>:<span class="st">'volume_rank'</span>})</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        .merge(df_stats_analysis, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'symbol'</span>])</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">'quotedate &lt;= "2017-12-31"'</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        .assign(iv_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'implied_vol'</span>].shift())</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        .assign(iv_change_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'implied_vol'</span>].pct_change().shift())</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        .assign(iv_change_two_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'implied_vol'</span>].pct_change().shift(<span class="dv">2</span>))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        .assign(daily_volume_rank <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'quotedate'</span>])[<span class="st">'totalvol'</span>].rank(ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        .sort_values([<span class="st">'symbol'</span>, <span class="st">'quotedate'</span>])</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        .merge(df_stock[[<span class="st">'symbol'</span>, <span class="st">'quotedate'</span>, <span class="st">'px_close'</span>]], how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'symbol'</span>, <span class="st">'quotedate'</span>])</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        .assign(daily_return <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'px_close'</span>].pct_change())</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        .assign(scaled_return <span class="op">=</span> <span class="kw">lambda</span> df: df.daily_return <span class="op">/</span> (df.iv_one_lag <span class="op">/</span> np.sqrt(<span class="dv">252</span>)))</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        .assign(scaled_return_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">'scaled_return'</span>].shift())</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        .assign(scaled_return_two_lag <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">'scaled_return'</span>].shift(<span class="dv">2</span>))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        .assign(rank_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'daily_volume_rank'</span>].shift())</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        .assign(rank_two_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'daily_volume_rank'</span>].shift(<span class="dv">2</span>))</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        .assign(rank_change <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'daily_volume_rank'</span>].diff())</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        .assign(rank_change_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'rank_change'</span>].shift())</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        .assign(rank_change_two_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'rank_change'</span>].shift(<span class="dv">2</span>))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>df_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">volume_rank</th>
<th data-quarto-table-cell-role="th">quotedate</th>
<th data-quarto-table-cell-role="th">implied_vol</th>
<th data-quarto-table-cell-role="th">totalvol</th>
<th data-quarto-table-cell-role="th">totaloi</th>
<th data-quarto-table-cell-role="th">iv_one_lag</th>
<th data-quarto-table-cell-role="th">iv_change_one_lag</th>
<th data-quarto-table-cell-role="th">iv_change_two_lag</th>
<th data-quarto-table-cell-role="th">daily_volume_rank</th>
<th data-quarto-table-cell-role="th">px_close</th>
<th data-quarto-table-cell-role="th">daily_return</th>
<th data-quarto-table-cell-role="th">scaled_return</th>
<th data-quarto-table-cell-role="th">scaled_return_one_lag</th>
<th data-quarto-table-cell-role="th">scaled_return_two_lag</th>
<th data-quarto-table-cell-role="th">rank_one_lag</th>
<th data-quarto-table-cell-role="th">rank_two_lag</th>
<th data-quarto-table-cell-role="th">rank_change</th>
<th data-quarto-table-cell-role="th">rank_change_one_lag</th>
<th data-quarto-table-cell-role="th">rank_change_two_lag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>ACAD</td>
<td>57.0</td>
<td>2017-01-06</td>
<td>0.8471</td>
<td>4184</td>
<td>120009</td>
<td>0.7940</td>
<td>-0.075992</td>
<td>0.097165</td>
<td>65.5</td>
<td>32.64</td>
<td>0.030303</td>
<td>0.605851</td>
<td>-0.150381</td>
<td>2.233300</td>
<td>73.0</td>
<td>7.0</td>
<td>-7.5</td>
<td>66.0</td>
<td>-103.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>ACAD</td>
<td>57.0</td>
<td>2017-01-09</td>
<td>0.7463</td>
<td>2541</td>
<td>118250</td>
<td>0.8471</td>
<td>0.066877</td>
<td>-0.075992</td>
<td>97.0</td>
<td>32.69</td>
<td>0.001532</td>
<td>0.028707</td>
<td>0.605851</td>
<td>-0.150381</td>
<td>65.5</td>
<td>73.0</td>
<td>31.5</td>
<td>-7.5</td>
<td>66.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>ACAD</td>
<td>57.0</td>
<td>2017-01-10</td>
<td>0.8257</td>
<td>2145</td>
<td>119307</td>
<td>0.7463</td>
<td>-0.118994</td>
<td>0.066877</td>
<td>116.0</td>
<td>31.47</td>
<td>-0.037320</td>
<td>-0.793838</td>
<td>0.028707</td>
<td>0.605851</td>
<td>97.0</td>
<td>65.5</td>
<td>19.0</td>
<td>31.5</td>
<td>-7.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>ACAD</td>
<td>57.0</td>
<td>2017-01-11</td>
<td>0.7765</td>
<td>3366</td>
<td>120644</td>
<td>0.8257</td>
<td>0.106392</td>
<td>-0.118994</td>
<td>62.0</td>
<td>29.87</td>
<td>-0.050842</td>
<td>-0.977465</td>
<td>-0.793838</td>
<td>0.028707</td>
<td>116.0</td>
<td>97.0</td>
<td>-54.0</td>
<td>19.0</td>
<td>31.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>ACAD</td>
<td>57.0</td>
<td>2017-01-12</td>
<td>0.7953</td>
<td>5229</td>
<td>122426</td>
<td>0.7765</td>
<td>-0.059586</td>
<td>0.106392</td>
<td>32.0</td>
<td>31.78</td>
<td>0.063944</td>
<td>1.307245</td>
<td>-0.977465</td>
<td>-0.793838</td>
<td>62.0</td>
<td>116.0</td>
<td>-30.0</td>
<td>-54.0</td>
<td>19.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75295</td>
<td>ZTS</td>
<td>249.0</td>
<td>2017-12-22</td>
<td>0.1581</td>
<td>2843</td>
<td>89209</td>
<td>0.1865</td>
<td>0.085565</td>
<td>0.216714</td>
<td>79.0</td>
<td>71.99</td>
<td>-0.004012</td>
<td>-0.341508</td>
<td>-0.546451</td>
<td>-0.138988</td>
<td>29.0</td>
<td>19.0</td>
<td>50.0</td>
<td>10.0</td>
<td>-200.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75296</td>
<td>ZTS</td>
<td>249.0</td>
<td>2017-12-26</td>
<td>0.1485</td>
<td>773</td>
<td>89968</td>
<td>0.1581</td>
<td>-0.152279</td>
<td>0.085565</td>
<td>202.0</td>
<td>72.34</td>
<td>0.004862</td>
<td>0.488162</td>
<td>-0.341508</td>
<td>-0.546451</td>
<td>79.0</td>
<td>29.0</td>
<td>123.0</td>
<td>50.0</td>
<td>10.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75297</td>
<td>ZTS</td>
<td>249.0</td>
<td>2017-12-27</td>
<td>0.1490</td>
<td>780</td>
<td>90270</td>
<td>0.1485</td>
<td>-0.060721</td>
<td>-0.152279</td>
<td>192.0</td>
<td>72.45</td>
<td>0.001521</td>
<td>0.162550</td>
<td>0.488162</td>
<td>-0.341508</td>
<td>202.0</td>
<td>79.0</td>
<td>-10.0</td>
<td>123.0</td>
<td>50.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75298</td>
<td>ZTS</td>
<td>249.0</td>
<td>2017-12-28</td>
<td>0.1484</td>
<td>718</td>
<td>90161</td>
<td>0.1490</td>
<td>0.003367</td>
<td>-0.060721</td>
<td>199.5</td>
<td>72.39</td>
<td>-0.000828</td>
<td>-0.088232</td>
<td>0.162550</td>
<td>0.488162</td>
<td>192.0</td>
<td>202.0</td>
<td>7.5</td>
<td>-10.0</td>
<td>123.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75299</td>
<td>ZTS</td>
<td>249.0</td>
<td>2017-12-29</td>
<td>0.1491</td>
<td>808</td>
<td>89855</td>
<td>0.1484</td>
<td>-0.004027</td>
<td>0.003367</td>
<td>212.0</td>
<td>72.04</td>
<td>-0.004835</td>
<td>-0.517197</td>
<td>-0.088232</td>
<td>0.162550</td>
<td>199.5</td>
<td>192.0</td>
<td>12.5</td>
<td>7.5</td>
<td>-10.0</td>
</tr>
</tbody>
</table>

<p>74400 rows Ã— 20 columns</p>
</div>
</div>
</div>
<p>We will do the same feature construction for the backtest period, but the filtering will have different dates.</p>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> <span class="op">\</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    df_universe[[<span class="st">'symbol'</span>,<span class="st">'rerank'</span>]]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'rerank'</span>:<span class="st">'volume_rank'</span>})</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        .merge(df_stats_analysis, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'symbol'</span>])</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">'quotedate &gt; "2017-12-31"'</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        .assign(iv_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'implied_vol'</span>].shift())</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        .assign(iv_change_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'implied_vol'</span>].pct_change().shift())</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        .assign(iv_change_two_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'implied_vol'</span>].pct_change().shift(<span class="dv">2</span>))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        .assign(daily_volume_rank <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'quotedate'</span>])[<span class="st">'totalvol'</span>].rank(ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        .sort_values([<span class="st">'symbol'</span>, <span class="st">'quotedate'</span>])</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        .merge(df_stock[[<span class="st">'symbol'</span>, <span class="st">'quotedate'</span>, <span class="st">'px_close'</span>]], how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'symbol'</span>, <span class="st">'quotedate'</span>])</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        .assign(daily_return <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'px_close'</span>].pct_change())</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        .assign(scaled_return <span class="op">=</span> <span class="kw">lambda</span> df: df.daily_return <span class="op">/</span> (df.iv_one_lag <span class="op">/</span> np.sqrt(<span class="dv">252</span>)))</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        .assign(scaled_return_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">'scaled_return'</span>].shift())</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        .assign(scaled_return_two_lag <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">'scaled_return'</span>].shift(<span class="dv">2</span>))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        .assign(rank_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'daily_volume_rank'</span>].shift())</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        .assign(rank_two_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'daily_volume_rank'</span>].shift(<span class="dv">2</span>))</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        .assign(rank_change <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'daily_volume_rank'</span>].diff())</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        .assign(rank_change_one_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'rank_change'</span>].shift())</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        .assign(rank_change_two_lag <span class="op">=</span> <span class="kw">lambda</span> df: df.groupby([<span class="st">'symbol'</span>])[<span class="st">'rank_change'</span>].shift(<span class="dv">2</span>))</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>df_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">volume_rank</th>
<th data-quarto-table-cell-role="th">quotedate</th>
<th data-quarto-table-cell-role="th">implied_vol</th>
<th data-quarto-table-cell-role="th">totalvol</th>
<th data-quarto-table-cell-role="th">totaloi</th>
<th data-quarto-table-cell-role="th">iv_one_lag</th>
<th data-quarto-table-cell-role="th">iv_change_one_lag</th>
<th data-quarto-table-cell-role="th">iv_change_two_lag</th>
<th data-quarto-table-cell-role="th">daily_volume_rank</th>
<th data-quarto-table-cell-role="th">px_close</th>
<th data-quarto-table-cell-role="th">daily_return</th>
<th data-quarto-table-cell-role="th">scaled_return</th>
<th data-quarto-table-cell-role="th">scaled_return_one_lag</th>
<th data-quarto-table-cell-role="th">scaled_return_two_lag</th>
<th data-quarto-table-cell-role="th">rank_one_lag</th>
<th data-quarto-table-cell-role="th">rank_two_lag</th>
<th data-quarto-table-cell-role="th">rank_change</th>
<th data-quarto-table-cell-role="th">rank_change_one_lag</th>
<th data-quarto-table-cell-role="th">rank_change_two_lag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>ACAD</td>
<td>57.0</td>
<td>2018-01-05</td>
<td>0.5870</td>
<td>650</td>
<td>59158</td>
<td>0.5443</td>
<td>0.073147</td>
<td>0.047717</td>
<td>255.0</td>
<td>28.90</td>
<td>0.004170</td>
<td>0.121605</td>
<td>-0.774238</td>
<td>-1.022725</td>
<td>60.0</td>
<td>142.0</td>
<td>195.0</td>
<td>-82.0</td>
<td>121.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>ACAD</td>
<td>57.0</td>
<td>2018-01-08</td>
<td>0.6228</td>
<td>15210</td>
<td>58518</td>
<td>0.5870</td>
<td>0.078449</td>
<td>0.073147</td>
<td>7.0</td>
<td>27.11</td>
<td>-0.061938</td>
<td>-1.675010</td>
<td>0.121605</td>
<td>-0.774238</td>
<td>255.0</td>
<td>60.0</td>
<td>-248.0</td>
<td>195.0</td>
<td>-82.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>ACAD</td>
<td>57.0</td>
<td>2018-01-09</td>
<td>0.6016</td>
<td>2152</td>
<td>68583</td>
<td>0.6228</td>
<td>0.060988</td>
<td>0.078449</td>
<td>153.0</td>
<td>28.29</td>
<td>0.043526</td>
<td>1.109441</td>
<td>-1.675010</td>
<td>0.121605</td>
<td>7.0</td>
<td>255.0</td>
<td>146.0</td>
<td>-248.0</td>
<td>195.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>ACAD</td>
<td>57.0</td>
<td>2018-01-10</td>
<td>0.5761</td>
<td>798</td>
<td>65129</td>
<td>0.6016</td>
<td>-0.034040</td>
<td>0.060988</td>
<td>237.0</td>
<td>28.63</td>
<td>0.012018</td>
<td>0.317131</td>
<td>1.109441</td>
<td>-1.675010</td>
<td>153.0</td>
<td>7.0</td>
<td>84.0</td>
<td>146.0</td>
<td>-248.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>ACAD</td>
<td>57.0</td>
<td>2018-01-11</td>
<td>0.5355</td>
<td>1081</td>
<td>65813</td>
<td>0.5761</td>
<td>-0.042387</td>
<td>-0.034040</td>
<td>236.0</td>
<td>27.90</td>
<td>-0.025498</td>
<td>-0.702593</td>
<td>0.317131</td>
<td>1.109441</td>
<td>237.0</td>
<td>153.0</td>
<td>-1.0</td>
<td>84.0</td>
<td>146.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6295</td>
<td>ZTS</td>
<td>249.0</td>
<td>2018-01-25</td>
<td>0.2039</td>
<td>1662</td>
<td>24055</td>
<td>0.2025</td>
<td>0.006962</td>
<td>0.021331</td>
<td>177.0</td>
<td>79.25</td>
<td>0.011745</td>
<td>0.920736</td>
<td>0.752860</td>
<td>0.114461</td>
<td>203.0</td>
<td>227.0</td>
<td>-26.0</td>
<td>-24.0</td>
<td>-5.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6296</td>
<td>ZTS</td>
<td>249.0</td>
<td>2018-01-26</td>
<td>0.2046</td>
<td>4137</td>
<td>25213</td>
<td>0.2039</td>
<td>0.006914</td>
<td>0.006962</td>
<td>85.0</td>
<td>80.09</td>
<td>0.010599</td>
<td>0.825207</td>
<td>0.920736</td>
<td>0.752860</td>
<td>177.0</td>
<td>203.0</td>
<td>-92.0</td>
<td>-26.0</td>
<td>-24.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6297</td>
<td>ZTS</td>
<td>249.0</td>
<td>2018-01-29</td>
<td>0.2426</td>
<td>3662</td>
<td>26275</td>
<td>0.2046</td>
<td>0.003433</td>
<td>0.006914</td>
<td>96.0</td>
<td>79.18</td>
<td>-0.011362</td>
<td>-0.881572</td>
<td>0.825207</td>
<td>0.920736</td>
<td>85.0</td>
<td>177.0</td>
<td>11.0</td>
<td>-92.0</td>
<td>-26.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6298</td>
<td>ZTS</td>
<td>249.0</td>
<td>2018-01-30</td>
<td>0.2604</td>
<td>365</td>
<td>29722</td>
<td>0.2426</td>
<td>0.185728</td>
<td>0.003433</td>
<td>276.0</td>
<td>78.35</td>
<td>-0.010482</td>
<td>-0.685918</td>
<td>-0.881572</td>
<td>0.825207</td>
<td>96.0</td>
<td>85.0</td>
<td>180.0</td>
<td>11.0</td>
<td>-92.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6299</td>
<td>ZTS</td>
<td>249.0</td>
<td>2018-01-31</td>
<td>0.2419</td>
<td>1333</td>
<td>29890</td>
<td>0.2604</td>
<td>0.073372</td>
<td>0.185728</td>
<td>184.0</td>
<td>76.77</td>
<td>-0.020166</td>
<td>-1.229355</td>
<td>-0.685918</td>
<td>-0.881572</td>
<td>276.0</td>
<td>96.0</td>
<td>-92.0</td>
<td>180.0</td>
<td>11.0</td>
</tr>
</tbody>
</table>

<p>5400 rows Ã— 20 columns</p>
</div>
</div>
</div>
<p>Letâ€™s export both the training data and backtest data to CSVs for future use.</p>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df_train.to_csv(<span class="st">'../data/option_train_2017.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>df_test.to_csv(<span class="st">'../data/option_test_2018.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exploratory-data-analysis-of-training-data" class="level2" data-number="36.6">
<h2 data-number="36.6" class="anchored" data-anchor-id="exploratory-data-analysis-of-training-data"><span class="header-section-number">36.6</span> Exploratory Data Analysis of Training Data</h2>
<p>Letâ€™s perform some exploratory data analysis on our training data.</p>
<p>Our first observation is that there is a high correlation between an underlyingâ€™s previous day rank and its current rank, which makes intuitive sense.</p>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_train[[<span class="st">'rank_one_lag'</span>, <span class="st">'daily_volume_rank'</span>]].corr()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rank_one_lag</th>
<th data-quarto-table-cell-role="th">daily_volume_rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">rank_one_lag</td>
<td>1.000000</td>
<td>0.559952</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">daily_volume_rank</td>
<td>0.559952</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Next, we can see that there is a fair amount of mean reversion in ranks, which means if the rank increased yesterday, it is likely to decrease today, and vice versa.</p>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_train.plot(kind<span class="op">=</span><span class="st">'scatter'</span>, x<span class="op">=</span><span class="st">'rank_change_one_lag'</span>, y<span class="op">=</span><span class="st">'rank_change'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="option_volume_introduction_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_train[[<span class="st">'rank_change_one_lag'</span>, <span class="st">'rank_change'</span>]].corr()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rank_change_one_lag</th>
<th data-quarto-table-cell-role="th">rank_change</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">rank_change_one_lag</td>
<td>1.000000</td>
<td>-0.434256</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">rank_change</td>
<td>-0.434256</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Since the correlation is stronger for <code>rank</code> than it is for <code>rank-change</code>, so we will perform predictive modeling on rank.</p>
</section>
<section id="top-n-ratio" class="level2" data-number="36.7">
<h2 data-number="36.7" class="anchored" data-anchor-id="top-n-ratio"><span class="header-section-number">36.7</span> Top-<span class="math inline">\(n\)</span> Ratio</h2>
<p>Ultimately, we donâ€™t care if we get the volume rank predictions exactly right. For example, if we correctly guess the top 10 underlyings, we donâ€™t care if we get the ordering right.</p>
<p>For this reason, letâ€™s consider the <em>top-</em><span class="math inline">\(n\)</span> ratio metric, which compares the ratio of our predicted top-<span class="math inline">\(n\)</span> ranked volume, and the actual top-<span class="math inline">\(n\)</span> ranked volume. Note that this ratio is always less that or equal to 1.</p>
<p>Weâ€™ll begin by creating a function that calculates the top-<span class="math inline">\(n\)</span> volume for all the days in our backtest period.</p>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> top_n_volume(n):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    df_test <span class="op">=</span> pd.read_csv(<span class="st">"../data/option_test_2018.csv"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    df_top_n_volume <span class="op">=</span> <span class="op">\</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    df_test</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">'daily_volume_rank &lt;= @n'</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'quotedate'</span>])[[<span class="st">'totalvol'</span>]].<span class="bu">sum</span>()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'totalvol'</span>:<span class="st">'top_'</span> <span class="op">+</span> <span class="bu">str</span>(n) <span class="op">+</span> <span class="st">'_volume'</span>})</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(df_top_n_volume)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Letâ€™s examine the output of this function.</p>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>top_n_volume(<span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">quotedate</th>
<th data-quarto-table-cell-role="th">top_25_volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2018-01-05</td>
<td>659260</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2018-01-08</td>
<td>516046</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2018-01-09</td>
<td>543219</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2018-01-10</td>
<td>598589</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2018-01-11</td>
<td>559668</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2018-01-12</td>
<td>634138</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2018-01-16</td>
<td>484750</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2018-01-17</td>
<td>711695</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2018-01-18</td>
<td>510736</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2018-01-19</td>
<td>735554</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2018-01-22</td>
<td>508607</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2018-01-23</td>
<td>580468</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2018-01-24</td>
<td>601835</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2018-01-25</td>
<td>524369</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2018-01-26</td>
<td>547504</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2018-01-29</td>
<td>511379</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>2018-01-30</td>
<td>493253</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>2018-01-31</td>
<td>499669</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="a-simple-rule-based-predictor" class="level2" data-number="36.8">
<h2 data-number="36.8" class="anchored" data-anchor-id="a-simple-rule-based-predictor"><span class="header-section-number">36.8</span> A Simple Rule-Based Predictor</h2>
<p>Recall that there is a high degree of correlation between yesterdayâ€™s volume rank and todayâ€™s volume rank. This observation leads to the following rules based predictor: <em>tomorrowâ€™s volume rank is equal to todayâ€™s</em>. In a later section we will compare the performance of this simple rule-based predictor with linear regression on two features.</p>
</section>
<section id="user-defined-functions" class="level2" data-number="36.9">
<h2 data-number="36.9" class="anchored" data-anchor-id="user-defined-functions"><span class="header-section-number">36.9</span> User Defined Functions</h2>
<p>In order to evaluate predictors with top-<span class="math inline">\(n\)</span> ratio we will need the following two function functions.</p>
<p>The <code>calc_top_n_ratio()</code> function calculates the top-<span class="math inline">\(n\)</span> ratio for a given fitted <code>model</code>, for a given <code>trade_date</code>.</p>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_top_n_ratio(n, trade_date, df_test, model<span class="op">=</span><span class="va">None</span>, features<span class="op">=</span>[]):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grabbing top-n volume for each day in backtest</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    df_top_n <span class="op">=</span> top_n_volume(n)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grabbing feature observations for trade_date</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    df_prediction <span class="op">=</span> df_test.query(<span class="st">'quotedate == @trade_date'</span>).copy()</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># selecting features from df_X</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    df_X <span class="op">=</span> df_prediction[features]</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculating model predictions</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        df_prediction[<span class="st">'prediction'</span>] <span class="op">=</span> model.predict(df_X) <span class="co"># predictions base on model</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        df_prediction[<span class="st">'prediction'</span>] <span class="op">=</span> df_prediction[<span class="st">'rank_one_lag'</span>] <span class="co"># simple-rule based</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sorting by predicted rank</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    df_prediction <span class="op">=</span> df_prediction.sort_values([<span class="st">'prediction'</span>])</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculating predicted top-n volume</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    predicted_top_n_volume <span class="op">=</span> df_prediction.head(n)[<span class="st">'totalvol'</span>].<span class="bu">sum</span>()</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># querying for actual top-n volume</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    actual_top_n_volume <span class="op">=</span> df_top_n.query(<span class="st">'quotedate == @trade_date'</span>)[<span class="st">'top_'</span> <span class="op">+</span> <span class="bu">str</span>(n) <span class="op">+</span> <span class="st">'_volume'</span>].values[<span class="dv">0</span>]</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return the top-n-ratio</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(predicted_top_n_volume <span class="op">/</span> actual_top_n_volume)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>backtest()</code> function takes a fitted <code>model</code> and loops through all the <code>trade_dates</code> in the backtest period and uses the <code>calc_top_n_ratio()</code> function to calculate the all the top-<span class="math inline">\(n\)</span> ratios.</p>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest(n, df_test, model<span class="op">=</span><span class="va">None</span>, features<span class="op">=</span>[]):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># all trade dates in backtest period</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    trade_dates <span class="op">=</span> df_test[<span class="st">'quotedate'</span>].unique().tolist()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculating all top-n ratios</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    top_n_ratios <span class="op">=</span> []</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ix_trade_date <span class="kw">in</span> trade_dates:</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        top_n_ratios.append(calc_top_n_ratio(n, ix_trade_date, df_test, model, features))</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># creating a dataframe of daily top-n ratios</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    df_daily <span class="op">=</span> pd.DataFrame({</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'trade_date'</span>:trade_dates,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'top_'</span><span class="op">+</span><span class="bu">str</span>(n)<span class="op">+</span><span class="st">'_volume'</span>: np.<span class="bu">round</span>(top_n_ratios, <span class="dv">3</span>),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculating summary statsics of top-n ratios during backtest period</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    df_stats <span class="op">=</span> pd.DataFrame({</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model'</span>:[<span class="bu">str</span>(model)],</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'average'</span>:[np.mean(top_n_ratios).<span class="bu">round</span>(<span class="dv">3</span>)],</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'std_dev'</span>:[np.std(top_n_ratios).<span class="bu">round</span>(<span class="dv">3</span>)],</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'minimum'</span>:[np.<span class="bu">min</span>(top_n_ratios).<span class="bu">round</span>(<span class="dv">3</span>)],</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'maximum'</span>:[np.<span class="bu">max</span>(top_n_ratios).<span class="bu">round</span>(<span class="dv">3</span>)],</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>([df_daily, df_stats])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculating-performance-of-simple-rule-based-predictor" class="level2" data-number="36.10">
<h2 data-number="36.10" class="anchored" data-anchor-id="calculating-performance-of-simple-rule-based-predictor"><span class="header-section-number">36.10</span> Calculating Performance of Simple Rule-Based Predictor</h2>
<p>We can now use the functions defined above to calculate the performance of the simple rule-based predictor.</p>
<p>As we can see, a simple rule-based scheme of simply guessing that volume rank remains unchanged has an average top-25 ratio of 59%.</p>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>backtest(<span class="dv">25</span>, df_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[    trade_date  top_25_volume
 0   2018-01-05          0.768
 1   2018-01-08          0.556
 2   2018-01-09          0.624
 3   2018-01-10          0.467
 4   2018-01-11          0.678
 5   2018-01-12          0.504
 6   2018-01-16          0.591
 7   2018-01-17          0.516
 8   2018-01-18          0.419
 9   2018-01-19          0.610
 10  2018-01-22          0.675
 11  2018-01-23          0.562
 12  2018-01-24          0.550
 13  2018-01-25          0.563
 14  2018-01-26          0.722
 15  2018-01-29          0.592
 16  2018-01-30          0.525
 17  2018-01-31          0.753,
   model  average  std_dev  minimum  maximum
 0  None    0.593    0.094    0.419    0.768]</code></pre>
</div>
</div>
</section>
<section id="simple-linear-regression" class="level2" data-number="36.11">
<h2 data-number="36.11" class="anchored" data-anchor-id="simple-linear-regression"><span class="header-section-number">36.11</span> Simple Linear Regression</h2>
<p>Letâ€™s fit a linear regression with <code>rank_one_lag</code> and <code>rank_two_lag</code> and then see if this model does better.</p>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> [<span class="st">'rank_one_lag'</span>, <span class="st">'rank_two_lag'</span>]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>df_features <span class="op">=</span> df_train[features]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>df_label <span class="op">=</span> df_train[[<span class="st">'daily_volume_rank'</span>]]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>linear_regression <span class="op">=</span> LinearRegression()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>linear_regression.fit(df_features, np.ravel(df_label.values))</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>linear_regression.score(df_features, df_label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.3652412348607029</code></pre>
</div>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>backtest(<span class="dv">25</span>, df_test, linear_regression, features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[    trade_date  top_25_volume
 0   2018-01-05          0.816
 1   2018-01-08          0.634
 2   2018-01-09          0.651
 3   2018-01-10          0.531
 4   2018-01-11          0.734
 5   2018-01-12          0.500
 6   2018-01-16          0.620
 7   2018-01-17          0.461
 8   2018-01-18          0.478
 9   2018-01-19          0.610
 10  2018-01-22          0.696
 11  2018-01-23          0.580
 12  2018-01-24          0.584
 13  2018-01-25          0.620
 14  2018-01-26          0.709
 15  2018-01-29          0.605
 16  2018-01-30          0.736
 17  2018-01-31          0.667,
                 model  average  std_dev  minimum  maximum
 0  LinearRegression()    0.624    0.092    0.461    0.816]</code></pre>
</div>
</div>
<p>Clearly the improvement is only modest. The average top-25 ratio of the linear regression is 3-points higher. Additionally, the standard deviation is slightly lower, and the min and max are both closer to 100%.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../chapters/32_student_loan_xgboost/student_loan_xgboost.html" class="pagination-link" aria-label="Student Loan: **xgboost**">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Student Loan: <strong>xgboost</strong></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/34_option_volume_feature_selection/option_volume_feature_selection.html" class="pagination-link" aria-label="Option Volume: Feature Selection and Hyperparameter Tuning">
        <span class="nav-page-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Option Volume: Feature Selection and Hyperparameter Tuning</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>